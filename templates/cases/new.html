<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحليل قضية جديدة - المحامي الذكي</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>المحامي الذكي</h1>
        <nav>
            <a href="{{ url_for('index') }}">الرئيسية</a>
            <a href="{{ url_for('case.cases') }}">القضايا</a>
        </nav>
    </header>

    <main>
        <section class="new-case">
            <h2>تحليل قضية جديدة</h2>
            <div class="case-form">
                <div class="form-group">
                    <label for="title">عنوان القضية:</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="description">وصف القضية:</label>
                    <textarea id="description" name="description" rows="10" required 
                        placeholder="يرجى وصف القضية بالتفصيل، متضمناً:
- الوقائع والأحداث
- الأطراف المعنية
- التواريخ المهمة
- الوثائق والمستندات المتوفرة
- أي معلومات إضافية ذات صلة"></textarea>
                </div>
                <button type="button" id="startAnalysis" class="btn">بدء التحليل الشامل</button>
            </div>

            <div class="analyses-list">
                <!-- سيتم إضافة نتائج التحليل هنا -->
            </div>
        </section>
    </main>

    <footer>
        <p>جميع الحقوق محفوظة &copy; 2023</p>
    </footer>

    <script>
        const stages = [
            { id: 1, title: 'التحليل الأولي للنص', model: 'gemini' },
            { id: 2, title: 'تحليل الوقائع والأحداث', model: 'llama' },
            { id: 3, title: 'التحليل القانوني الأساسي', model: 'gemini' },
            { id: 4, title: 'تحليل الأدلة والمستندات', model: 'llama' },
            { id: 5, title: 'تحليل السوابق القضائية', model: 'gemini' },
            { id: 6, title: 'تحليل الحجج القانونية', model: 'llama' },
            { id: 7, title: 'تحليل الدفوع القانونية', model: 'gemini' },
            { id: 8, title: 'التحليل الإجرائي', model: 'llama' },
            { id: 9, title: 'صياغة الاستراتيجية القانونية', model: 'gemini' },
            { id: 10, title: 'تحليل المخاطر والفرص', model: 'llama' },
            { id: 11, title: 'اقتراح الحلول والبدائل', model: 'gemini' },
            { id: 12, title: 'إعداد الملخص النهائي', model: 'llama' }
        ];

        const analysesList = document.querySelector('.analyses-list');
        let currentCase = null;

        // إنشاء بطاقات التحليل
        stages.forEach(stage => {
            const card = document.createElement('div');
            card.className = 'analysis-card pending';
            card.id = `stage-${stage.id}`;
            card.innerHTML = `
                <div class="stage-header">
                    <h3>${stage.title}</h3>
                    <span class="model-badge ${stage.model}">${stage.model === 'gemini' ? 'Google Gemini Pro' : 'Llama 3 (Groq)'}</span>
                </div>
                <div class="stage-content">
                    <div class="stage-status">في انتظار التحليل...</div>
                </div>
            `;
            analysesList.appendChild(card);
        });

        async function analyzeStage(stage, caseData) {
            const card = document.getElementById(`stage-${stage.id}`);
            card.className = 'analysis-card processing';
            card.querySelector('.stage-status').textContent = 'جاري التحليل...';

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: caseData.description,
                        stage: stage.id,
                        model_type: stage.model,
                        case_id: caseData.id
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    card.className = 'analysis-card completed';
                    card.querySelector('.stage-content').innerHTML = `
                        <div class="analysis-result">${data.result}</div>
                        <div class="analysis-meta">
                            <span class="analysis-time">${new Date().toLocaleTimeString()}</span>
                        </div>
                    `;
                } else {
                    throw new Error(data.message);
                }
                return true;
            } catch (error) {
                card.className = 'analysis-card error';
                card.querySelector('.stage-content').innerHTML = `
                    <div class="error-message">حدث خطأ: ${error.message}</div>
                    <button class="btn-retry" onclick="retryAnalysis(${stage.id})">إعادة المحاولة</button>
                `;
                return false;
            }
        }

        async function startAnalysis() {
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;

            if (!title || !description) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }

            try {
                // إنشاء القضية
                const response = await fetch('/api/cases/new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        parties: []
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    currentCase = {
                        id: data.case_id,
                        title: title,
                        description: description
                    };

                    // تعطيل نموذج الإدخال
                    document.getElementById('title').disabled = true;
                    document.getElementById('description').disabled = true;
                    document.getElementById('startAnalysis').disabled = true;

                    // بدء التحليل المتسلسل
                    for (const stage of stages) {
                        await analyzeStage(stage, currentCase);
                    }
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                alert('حدث خطأ أثناء إنشاء القضية: ' + error.message);
            }
        }

        async function retryAnalysis(stageId) {
            if (!currentCase) return;
            const stage = stages.find(s => s.id === stageId);
            if (stage) {
                await analyzeStage(stage, currentCase);
            }
        }

        document.getElementById('startAnalysis').addEventListener('click', startAnalysis);
    </script>
</body>
</html> 